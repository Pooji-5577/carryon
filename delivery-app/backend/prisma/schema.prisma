// Prisma Schema for CarryOn Delivery App

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Model
model User {
  id            String    @id @default(uuid())
  phone         String    @unique
  name          String?
  email         String?   @unique
  avatar        String?
  isVerified    Boolean   @default(false)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  orders        Order[]
  addresses     Address[]
  ratings       Rating[]
  chatMessages  ChatMessage[]
  supportTickets SupportTicket[]
  paymentMethods PaymentMethod[]
  notifications Notification[]

  @@map("users")
}

// Driver Model
model Driver {
  id              String    @id @default(uuid())
  phone           String    @unique
  name            String
  email           String?
  avatar          String?
  vehicleType     VehicleType
  vehicleNumber   String
  vehicleModel    String?
  licenseNumber   String
  isVerified      Boolean   @default(false)
  isActive        Boolean   @default(true)
  isOnline        Boolean   @default(false)
  rating          Float     @default(5.0)
  totalRatings    Int       @default(0)
  totalDeliveries Int       @default(0)
  currentLatitude Float?
  currentLongitude Float?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  orders          Order[]
  ratings         Rating[]
  chatMessages    ChatMessage[]

  @@map("drivers")
}

// Address Model
model Address {
  id          String      @id @default(uuid())
  userId      String
  label       String
  address     String
  latitude    Float
  longitude   Float
  type        AddressType @default(OTHER)
  isDefault   Boolean     @default(false)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("addresses")
}

// Order Model
model Order {
  id                  String        @id @default(uuid())
  userId              String
  driverId            String?
  
  // Pickup Location
  pickupLabel         String?
  pickupAddress       String
  pickupLatitude      Float
  pickupLongitude     Float
  pickupContactName   String?
  pickupContactPhone  String?
  
  // Drop Location
  dropLabel           String?
  dropAddress         String
  dropLatitude        Float
  dropLongitude       Float
  dropContactName     String?
  dropContactPhone    String?
  
  // Package Info
  packageDescription  String?
  packageWeight       Float?
  
  // Vehicle & Fare
  vehicleType         VehicleType
  distance            Float         // in meters
  duration            Int           // in seconds
  baseFare            Float
  distanceFare        Float
  timeFare            Float         @default(0)
  discount            Float         @default(0)
  promoCode           String?
  totalFare           Float
  
  // Status
  status              OrderStatus   @default(PENDING)
  paymentMethod       PaymentMethodType
  paymentStatus       PaymentStatus @default(PENDING)
  paymentId           String?
  
  // Timestamps
  scheduledAt         DateTime?
  acceptedAt          DateTime?
  pickedUpAt          DateTime?
  deliveredAt         DateTime?
  cancelledAt         DateTime?
  cancellationReason  String?
  
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  // Relations
  user                User          @relation(fields: [userId], references: [id])
  driver              Driver?       @relation(fields: [driverId], references: [id])
  statusHistory       OrderStatusHistory[]
  rating              Rating?
  chatMessages        ChatMessage[]
  payment             Payment?

  @@index([userId])
  @@index([driverId])
  @@index([status])
  @@map("orders")
}

// Order Status History
model OrderStatusHistory {
  id        String      @id @default(uuid())
  orderId   String
  status    OrderStatus
  note      String?
  latitude  Float?
  longitude Float?
  createdAt DateTime    @default(now())

  order     Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_status_history")
}

// Payment Model
model Payment {
  id              String        @id @default(uuid())
  orderId         String        @unique
  amount          Float
  currency        String        @default("INR")
  method          PaymentMethodType
  status          PaymentStatus @default(PENDING)
  gatewayId       String?       // Razorpay/Stripe payment ID
  gatewayOrderId  String?       // Gateway order ID
  gatewaySignature String?
  refundId        String?
  refundAmount    Float?
  metadata        Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  order           Order         @relation(fields: [orderId], references: [id])

  @@map("payments")
}

// Payment Method Model
model PaymentMethod {
  id          String            @id @default(uuid())
  userId      String
  type        PaymentMethodType
  name        String
  details     String            // Masked card number or UPI ID
  gatewayId   String?           // Saved card/method ID from gateway
  isDefault   Boolean           @default(false)
  createdAt   DateTime          @default(now())

  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payment_methods")
}

// Rating Model
model Rating {
  id          String    @id @default(uuid())
  orderId     String    @unique
  userId      String
  driverId    String
  rating      Int       // 1-5
  review      String?
  createdAt   DateTime  @default(now())

  order       Order     @relation(fields: [orderId], references: [id])
  user        User      @relation(fields: [userId], references: [id])
  driver      Driver    @relation(fields: [driverId], references: [id])

  @@map("ratings")
}

// Chat Message Model
model ChatMessage {
  id          String    @id @default(uuid())
  orderId     String
  senderId    String
  senderType  SenderType
  message     String
  isRead      Boolean   @default(false)
  createdAt   DateTime  @default(now())

  order       Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user        User?     @relation(fields: [senderId], references: [id])
  driver      Driver?   @relation(fields: [senderId], references: [id])

  @@map("chat_messages")
}

// Support Ticket Model
model SupportTicket {
  id          String        @id @default(uuid())
  userId      String
  orderId     String?
  category    String
  subject     String
  description String
  status      TicketStatus  @default(OPEN)
  priority    TicketPriority @default(MEDIUM)
  assignedTo  String?
  resolvedAt  DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  user        User          @relation(fields: [userId], references: [id])
  replies     TicketReply[]

  @@map("support_tickets")
}

// Ticket Reply Model
model TicketReply {
  id        String   @id @default(uuid())
  ticketId  String
  message   String
  isStaff   Boolean  @default(false)
  createdAt DateTime @default(now())

  ticket    SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@map("ticket_replies")
}

// Notification Model
model Notification {
  id        String   @id @default(uuid())
  userId    String
  title     String
  message   String
  type      String
  data      Json?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

// OTP Model
model OTP {
  id        String   @id @default(uuid())
  phone     String
  code      String
  expiresAt DateTime
  isUsed    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([phone, code])
  @@map("otps")
}

// Promo Code Model
model PromoCode {
  id              String    @id @default(uuid())
  code            String    @unique
  description     String?
  discountType    DiscountType
  discountValue   Float
  maxDiscount     Float?
  minOrderAmount  Float?
  maxUses         Int?
  usedCount       Int       @default(0)
  validFrom       DateTime
  validUntil      DateTime
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())

  @@map("promo_codes")
}

// Enums
enum VehicleType {
  BIKE
  CAR
  VAN
  TRUCK
}

enum AddressType {
  HOME
  WORK
  OTHER
}

enum OrderStatus {
  PENDING
  CONFIRMED
  DRIVER_ASSIGNED
  DRIVER_ARRIVED
  PICKUP_COMPLETE
  IN_TRANSIT
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethodType {
  CASH
  CARD
  UPI
  WALLET
  NET_BANKING
}

enum SenderType {
  USER
  DRIVER
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum DiscountType {
  PERCENTAGE
  FIXED
}
